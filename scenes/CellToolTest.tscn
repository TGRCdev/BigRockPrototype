[gd_scene load_steps=10 format=2]

[ext_resource path="res://scripts/bigrock_pt/ellipsoid_tool.gd" type="Script" id=1]

[sub_resource type="SpatialMaterial" id=1]
flags_unshaded = true
albedo_color = Color( 1, 0, 0, 1 )

[sub_resource type="GDScript" id=2]
script/source = "extends ImmediateGeometry

var colors = [
	Color.red,
	Color.green,
	Color.blue,
	Color.yellow
]

var lines = [[0, 1], [1, 3], [2, 3], [2, 0], [4, 5], [5, 7], [6, 7], [6, 4], [0, 4], [1, 5], [2, 6], [3, 7]];

func draw_cell(cell):
	clear();
	begin(Mesh.PRIMITIVE_LINES);
	_draw_cell_rec(cell);
	end();

func _draw_cell_rec(cell):
	for line in lines:
		add_vertex(cell.vertices[line[0]].position);
		add_vertex(cell.vertices[line[1]].position);
	
	if not cell.is_leaf():
		for child in cell.children:
			_draw_cell_rec(child);"

[sub_resource type="GDScript" id=3]
script/source = "extends Node

var cell;
var action;

onready var thread : Thread = Thread.new();
var thread_finished = false;

var Terrain = load(\"res://scripts/bigrock_pt/terrain.gd\");

func _ready():
	cell = Terrain.Cell.new();
	cell.init_verts();
	draw_cell();
	action = Terrain.EmplaceAction.new();

func _process(delta):
	if thread.is_active() and thread_finished:
		thread.wait_to_finish();

func draw_cell():
	$\"..\"/ImmediateGeometry.draw_cell(cell);

func apply_tool(t):
	#thread.start(self, \"apply_tool_thread\", {\"tool\":t});
	apply_tool_thread({\"tool\":t});

func apply_tool_thread(userdata):
	thread_finished = false;
	var t = userdata.tool;
	Terrain.cell_apply_tool(cell, t, action);
	Terrain.try_undivide(cell);
	draw_cell();
	var tris = Terrain.polygonise_cell(cell);
	var st = SurfaceTool.new();
	st.deindex();
	st.begin(Mesh.PRIMITIVE_TRIANGLES);
	print(\"beginning a mesh of %d vertices...\" % tris.size());
	for vert in tris:
		st.add_vertex(vert);
	st.generate_normals(false);
	$TerrainMesh.mesh = st.commit();
	thread_finished = true;

func reset():
	Terrain.undivide_cell(cell);
	cell.init_verts();
	draw_cell();"

[sub_resource type="GDScript" id=4]
script/source = "extends Spatial

func _process(delta):
	if self:
		self.rotation_degrees.y += 45 * delta;"

[sub_resource type="SphereMesh" id=5]

[sub_resource type="SpatialMaterial" id=6]
flags_transparent = true
flags_unshaded = true
albedo_color = Color( 0.0431373, 0.909804, 1, 0.223529 )

[sub_resource type="GDScript" id=7]
script/source = "extends Panel

var t;
var cell;
var action;

func _ready():
	t = $\"..\"/Tool;
	cell = $\"..\"/Cell;
	action = $\"..\"/Cell.action;
	
	$Margin/VBox/Apply.connect(\"pressed\", self, \"apply_tool\");
	$Margin/VBox/RemoveToggle.connect(\"toggled\", self, \"set_remove\");
	$Margin/VBox/ToolPos/X.connect(\"value_changed\", self, \"set_tool_origin\", [0]);
	$Margin/VBox/ToolPos/Y.connect(\"value_changed\", self, \"set_tool_origin\", [1]);
	$Margin/VBox/ToolPos/Z.connect(\"value_changed\", self, \"set_tool_origin\", [2]);
	$Margin/VBox/ToolSize/X.connect(\"value_changed\", self, \"set_tool_scale\", [0]);
	$Margin/VBox/ToolSize/Y.connect(\"value_changed\", self, \"set_tool_scale\", [1]);
	$Margin/VBox/ToolSize/Z.connect(\"value_changed\", self, \"set_tool_scale\", [2]);
	$Margin/VBox/Subdiv/SpinBox.connect(\"value_changed\", self, \"set_action_subdiv\");
	$Margin/VBox/Reset.connect(\"pressed\", cell, \"reset\");
	$Margin/VBox/ShowGrid.connect(\"toggled\", self, \"set_node_visible\", [$\"..\"/ImmediateGeometry]);

func apply_tool():
	cell.apply_tool(t);

func set_tool_origin(newval, index):
	t.translation[index] = newval;

func set_tool_scale(newval, index):
	t.scale[index] = newval;

func set_action_subdiv(newval):
	action.max_subdiv_level = int(newval);

func set_remove(newval):
	action.remove = newval;

func set_node_visible(newval, node):
	node.visible = newval;"

[sub_resource type="GDScript" id=8]
script/source = "extends Label

var start;

func _ready():
	start = OS.get_static_memory_usage();

func _process(delta):
	if OS:
		self.text = \"Static Mem: %d KB\" % [float(OS.get_static_memory_usage() - start) / 1000.0];"

[node name="Root" type="Spatial"]

[node name="ImmediateGeometry" type="ImmediateGeometry" parent="."]
material_override = SubResource( 1 )
script = SubResource( 2 )

[node name="Cell" type="Node" parent="."]
script = SubResource( 3 )

[node name="TerrainMesh" type="MeshInstance" parent="Cell"]

[node name="CameraPivot" type="Spatial" parent="."]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0.5, 0.5, 0.5 )
script = SubResource( 4 )

[node name="Camera" type="Camera" parent="CameraPivot"]
transform = Transform( 1, 0, 0, 0, 0.906308, 0.422618, 0, -0.422618, 0.906308, 0, 0.633927, 1.35946 )

[node name="Tool" type="MeshInstance" parent="."]
mesh = SubResource( 5 )
material/0 = SubResource( 6 )
script = ExtResource( 1 )

[node name="Panel" type="Panel" parent="."]
margin_right = 350.0
margin_bottom = 284.0
script = SubResource( 7 )

[node name="Margin" type="MarginContainer" parent="Panel"]
anchor_right = 1.0
anchor_bottom = 1.0
custom_constants/margin_right = 10
custom_constants/margin_top = 10
custom_constants/margin_left = 10
custom_constants/margin_bottom = 10

[node name="VBox" type="VBoxContainer" parent="Panel/Margin"]
margin_left = 10.0
margin_top = 10.0
margin_right = 340.0
margin_bottom = 274.0
custom_constants/separation = 5
alignment = 1

[node name="StaticMem" type="Label" parent="Panel/Margin/VBox"]
margin_top = 11.0
margin_right = 330.0
margin_bottom = 25.0
custom_colors/font_color = Color( 1, 0, 0, 1 )
text = "Static Mem"
script = SubResource( 8 )

[node name="RemoveToggle" type="CheckButton" parent="Panel/Margin/VBox"]
margin_top = 30.0
margin_right = 330.0
margin_bottom = 70.0
text = "Remove"

[node name="Apply" type="Button" parent="Panel/Margin/VBox"]
margin_top = 75.0
margin_right = 330.0
margin_bottom = 95.0
text = "Apply Tool"

[node name="ToolPos" type="HBoxContainer" parent="Panel/Margin/VBox"]
editor/display_folded = true
margin_top = 100.0
margin_right = 330.0
margin_bottom = 124.0
alignment = 1

[node name="Label" type="Label" parent="Panel/Margin/VBox/ToolPos"]
margin_left = 36.0
margin_top = 5.0
margin_right = 59.0
margin_bottom = 19.0
text = "Pos"

[node name="X" type="SpinBox" parent="Panel/Margin/VBox/ToolPos"]
margin_left = 63.0
margin_right = 137.0
margin_bottom = 24.0
max_value = 1.0
step = 0.01

[node name="Y" type="SpinBox" parent="Panel/Margin/VBox/ToolPos"]
margin_left = 141.0
margin_right = 215.0
margin_bottom = 24.0
max_value = 1.0
step = 0.01

[node name="Z" type="SpinBox" parent="Panel/Margin/VBox/ToolPos"]
margin_left = 219.0
margin_right = 293.0
margin_bottom = 24.0
max_value = 1.0
step = 0.01

[node name="ToolSize" type="HBoxContainer" parent="Panel/Margin/VBox"]
editor/display_folded = true
margin_top = 129.0
margin_right = 330.0
margin_bottom = 153.0
alignment = 1

[node name="Label" type="Label" parent="Panel/Margin/VBox/ToolSize"]
margin_left = 31.0
margin_top = 5.0
margin_right = 64.0
margin_bottom = 19.0
text = "Scale"

[node name="X" type="SpinBox" parent="Panel/Margin/VBox/ToolSize"]
margin_left = 68.0
margin_right = 142.0
margin_bottom = 24.0
max_value = 1.0
step = 0.01
value = 1.0

[node name="Y" type="SpinBox" parent="Panel/Margin/VBox/ToolSize"]
margin_left = 146.0
margin_right = 220.0
margin_bottom = 24.0
max_value = 1.0
step = 0.01
value = 1.0

[node name="Z" type="SpinBox" parent="Panel/Margin/VBox/ToolSize"]
margin_left = 224.0
margin_right = 298.0
margin_bottom = 24.0
max_value = 1.0
step = 0.01
value = 1.0

[node name="Subdiv" type="HBoxContainer" parent="Panel/Margin/VBox"]
editor/display_folded = true
margin_top = 158.0
margin_right = 330.0
margin_bottom = 182.0

[node name="Label" type="Label" parent="Panel/Margin/VBox/Subdiv"]
margin_top = 5.0
margin_right = 110.0
margin_bottom = 19.0
text = "Max Subdiv Level"

[node name="SpinBox" type="SpinBox" parent="Panel/Margin/VBox/Subdiv"]
margin_left = 114.0
margin_right = 188.0
margin_bottom = 24.0
min_value = 1.0
max_value = 16.0
value = 1.0
rounded = true

[node name="Reset" type="Button" parent="Panel/Margin/VBox"]
margin_top = 187.0
margin_right = 330.0
margin_bottom = 207.0
text = "Reset Cell"

[node name="ShowGrid" type="CheckButton" parent="Panel/Margin/VBox"]
margin_top = 212.0
margin_right = 330.0
margin_bottom = 252.0
text = "Show Grid"
